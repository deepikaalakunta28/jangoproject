{% extends "base.html" %}
{% load static %}

{% block title %}{{ pin.title }} | Pin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pindetail.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}

<div class="pin-detail-wrapper">

  <!-- LEFT -->
  <div class="pin-left">
    <div class="pin-card">

      <div class="pin-image-box">
        <img src="{{ pin.image.url }}" alt="{{ pin.title }}">
      </div>

      <div class="pin-info-box">

        <!-- ACTIONS -->
        <div class="pin-actions">

          <!-- SAVE -->
          <button class="btn-action save-btn {% if user in pin.saved_by.all %}saved{% endif %}"
            data-pin-id="{{ pin.id }}">
            <i class="fa-solid fa-thumbtack"></i>
            {% if user in pin.saved_by.all %}Saved{% else %}Save{% endif %}
          </button>

          <!-- LIKE -->
          <button class="btn-action like-btn" data-pin-id="{{ pin.id }}">
            <i class="fa-solid fa-heart {% if user_liked %}liked{% endif %}"></i>
            <span class="like-count">{{ pin.likes.count }}</span>
          </button>

          <!-- DOWNLOAD -->
          <a href="{{ pin.image.url }}" download class="btn-action download-btn">
            <i class="fa-solid fa-download"></i>
          </a>

          <!-- DELETE -->
          {% if request.user.id == pin.user.id %}
          <a href="{% url 'delete_pin' pin.id %}" class="btn-action delete-btn"
            onclick="return confirm('Delete this pin?');">
            <i class="fa-solid fa-trash"></i>
          </a>
          {% endif %}
        </div>


        <!-- ⭐ MOVE PIN -->
        <!-- ⭐ MOVE PIN -->
        {% if request.user == pin.user %}
        <div class="move-pin-box">

          <form method="POST" action="{% url 'move_pin' pin.id %}">
            {% csrf_token %}

            <label class="move-label">Move to board</label>

            <div class="move-row">

              <select name="board_id" class="move-select" required>
                {% for b in user_boards %}
                <option value="{{ b.id }}" {% if pin.board_id == b.id %}selected{% endif %}>
                  {{ b.title }}
                </option>
                {% empty %}
                <option disabled>No boards found</option>
                {% endfor %}
              </select>

              <button type="submit" class="btn-move">Move</button>
            </div>

          </form>
        </div>
        {% endif %}

        <!-- ⭐ END MOVE -->


        <!-- USER -->
        <div class="pin-user">
          <span class="username">{{ pin.user.username }}</span>
        </div>

        <!-- TEXT -->
        <h2>{{ pin.title }}</h2>
        <p>{{ pin.description }}</p>


        <!-- COMMENTS -->
        <div class="pin-comments">

          <h3>Comments</h3>

          <div class="comments-box">
            {% if pin.comments.all %}
            {% for comment in pin.comments.all %}
            <div class="comment-item">

              <div class="avatar">
                {{ comment.user.username|slice:":1"|upper }}
              </div>

              <div class="comment-bubble">
                <strong>{{ comment.user.username }}</strong>
                <p>{{ comment.text }}</p>
                <span class="time">{{ comment.created_at|timesince }} ago</span>
              </div>

            </div>
            {% endfor %}
            {% else %}
            <p class="no-comments">No comments yet. Be the first!</p>
            {% endif %}
          </div>

          <form action="{% url 'add_comment' pin.id %}" method="POST" class="comment-form">
            {% csrf_token %}
            <input type="text" name="comment" placeholder="Add a comment..." required>
            <button type="submit">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </form>

        </div>


      </div>
    </div>
  </div>


  <!-- RIGHT -->
  <div class="pin-right">
    <h3>More like this</h3>

    <div class="related-pin-grid">
      {% for p in other_pins %}
      <a href="{% url 'pin_detail' p.id %}" class="related-pin">
        <img src="{{ p.image.url }}" alt="{{ p.title }}">
      </a>
      {% empty %}
      <p>No other pins found.</p>
      {% endfor %}
    </div>
  </div>

</div>

{% endblock %}


{% block extra_js %}

<!-- SAVE -->
<script>
  document.querySelectorAll(".save-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      fetch(`/save/${btn.dataset.pinId}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken }
      })
        .then(r => r.json())
        .then(data => {
          if (data.saved) {
            btn.classList.add("saved");
            btn.innerHTML = '<i class="fa-solid fa-thumbtack"></i> Saved';
          } else {
            btn.classList.remove("saved");
            btn.innerHTML = '<i class="fa-solid fa-thumbtack"></i> Save';
          }
        });
    });
  });
</script>


<!-- LIKE -->
<script>
  document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      fetch(`/pin/${btn.dataset.pinId}/like/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken }
      })
        .then(r => r.json())
        .then(data => {

          const icon = btn.querySelector("i");
          const count = btn.querySelector(".like-count");

          if (data.liked) {
            icon.classList.add("liked");
          } else {
            icon.classList.remove("liked");
          }

          count.textContent = data.likes_count;
        });
    });
  });
</script>

{% endblock %}